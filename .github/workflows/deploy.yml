---
name: CI & Deploy Homelab

"on":
  pull_request:
    branches: [main]
    types: [closed]
  push:
    branches: [main]

env:
  REPO_PATH: /tmp/homelab

jobs:
  lint-and-test:
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv and pre-commit
        run: |
          sudo apt-get update
          sudo apt-get install -y python3
          curl -LsSf https://astral.sh/uv/install.sh | sh
          . "$HOME/.local/bin/env"
          uv tool install --force pre-commit
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ runner.os }}|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit checks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Lint GitHub Actions Workflows
        uses: reviewdog/action-actionlint@f4bb4d50c4c9e45cc64f413d2bc438ea1cf2d9d5
        with:
          reporter: github-pr-check
          fail_level: error
          actionlint_flags: -ignore 'label "homelab" is unknown'

  security-scan:
    runs-on: [self-hosted, homelab]
    needs: lint-and-test
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create Docker cache directory
        run: mkdir -p ~/.docker/cache

      - name: Cache Docker layers
        uses: actions/cache@v5
        with:
          path: ~/.docker/cache
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: ${{ runner.os }}-docker-

      - name: Create TruffleHog cache directory
        run: mkdir -p ~/.docker/trufflehog

      - name: Cache TruffleHog image
        uses: actions/cache@v5
        with:
          path: ~/.docker/trufflehog
          key: trufflehog-${{ github.sha }}
          restore-keys: trufflehog-

      - name: Secret Scanning with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --log-level=2 --results=verified,unknown

  deploy:
    needs: [lint-and-test, security-scan]
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: [self-hosted, homelab]
    environment: production
    env:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

    steps:
      - name: Setup Doppler
        run: |
          doppler configure set token ${{ secrets.DOPPLER_TOKEN }}
          doppler configure set project ${{ secrets.DOPPLER_PROJECT }}
          doppler configure set config ${{ secrets.DOPPLER_CONFIG }}

      - name: Check and Update Repository
        run: |
          REPO_URL="$(doppler secrets get GH_RUNNER_REPO_URL --plain)"
          REPO_PATH="${{ env.REPO_PATH }}"

          if [ -d "$REPO_PATH" ]; then
            cd "$REPO_PATH"
            git fetch origin main
            git reset --hard origin/main
            git clean -fd docker/ --exclude=docker/.traefik_hash
          else
            mkdir -p "$(dirname "$REPO_PATH")"
            git clone "$REPO_URL" "$REPO_PATH"
          fi
          cd "$REPO_PATH"

      - name: Install Task CLI
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -b /usr/local/bin

      - name: Install Terraform
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget -q https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip -O /tmp/terraform.zip
          sudo unzip -o /tmp/terraform.zip -d /usr/local/bin/
          rm /tmp/terraform.zip

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Terraform Init
        run: |
          cd "$REPO_PATH"
          task tf:init

      - name: Terraform Apply
        run: |
          cd "$REPO_PATH"
          task tf:apply

      - name: Ansible Init
        run: |
          cd "$REPO_PATH"
          task ansible:init

      - name: Ansible Apply
        run: |
          cd "$REPO_PATH"
          task ansible:apply

      - name: Terraform Apps Init
        run: |
          cd "$REPO_PATH"
          task tfa:init

      - name: Terraform Apps Apply
        run: |
          cd "$REPO_PATH"
          task tfa:apply

      - name: Deployment Summary
        run: |
          echo "Deployment completed successfully!"
