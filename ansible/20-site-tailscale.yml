---
# Tailscale configuration playbook - secure fabric setup
- name: "Install and authenticate Tailscale"
  hosts: vms
  become: true
  collections:
    - artis3n.tailscale
  tags: ["tailscale", "network"]
  tasks:
    - name: "Wait for tailscale to be ready"
      ansible.builtin.pause:
        seconds: 5
    - name: "Install and configure Tailscale"
      ansible.builtin.include_role:
        name: artis3n.tailscale.machine
      vars:
        tailscale_authkey: "{{ lookup('env', 'TAILSCALE_AUTH_KEY') }}"
        tailscale_args: "--accept-routes=false --ssh"

    - name: "Debug - Check Tailscale service logs"
      ansible.builtin.shell: "journalctl -u tailscaled --no-pager -n 50"
      register: tailscale_logs
      changed_when: false
      when: not ansible_check_mode

    - name: "Debug - Show Tailscale logs"
      ansible.builtin.debug:
        var: tailscale_logs.stdout_lines
      when: not ansible_check_mode

    - name: "Debug - Check Tailscale status"
      ansible.builtin.shell: "tailscale status"
      register: tailscale_status
      changed_when: false
      when: not ansible_check_mode

    - name: "Debug - Show Tailscale status"
      ansible.builtin.debug:
        var: tailscale_status.stdout_lines
      when: not ansible_check_mode

    - name: "Debug - Check Tailscale IP"
      ansible.builtin.shell: "tailscale ip -4"
      register: tailscale_ip_check
      changed_when: false
      failed_when: false # Don't fail if the command fails
      when: not ansible_check_mode

    - name: "Debug - Show Tailscale IP"
      ansible.builtin.debug:
        var: tailscale_ip_check.stdout_lines
      when: not ansible_check_mode

    - name: "Run tailscale_post validation"
      ansible.builtin.include_role:
        name: tailscale_post
      when: not ansible_check_mode
