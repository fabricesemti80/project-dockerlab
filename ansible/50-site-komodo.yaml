---
# Komodo installation and configuration playbook
# Based on: https://komo.do/docs/setup/mongo

# Environment Variables Required (to be added to Doppler):
# - KOMODO_DB_HOST: MongoDB connection host (default: mongodb)
# - KOMODO_DB_PORT: MongoDB connection port (default: 27017)
# - KOMODO_DB_NAME: MongoDB database name (default: komodo)
# - KOMODO_DB_USERNAME: MongoDB username (optional)
# - KOMODO_DB_PASSWORD: MongoDB password (optional)
# - KOMODO_PORT: Komodo web interface port (default: 3000)
# - KOMODO_SECRET: Secret key for session encryption (required)
# - KOMODO_LOG_LEVEL: Logging level (default: info)

- name: "Install and configure Komodo on cloud node"
  hosts: swarm_managers
  become: true
  tags: ["komodo", "applications"]
  vars:
    komodo_port: "{{ lookup('env', 'KOMODO_PORT') | default('3000', true) }}"
    komodo_secret: "{{ lookup('env', 'KOMODO_SECRET') | default('change-me-in-production', true) }}"
    komodo_db_host: "{{ lookup('env', 'KOMODO_DB_HOST') | default('mongodb', true) }}"
    komodo_db_port: "{{ lookup('env', 'KOMODO_DB_PORT') | default('27017', true) }}"
    komodo_db_name: "{{ lookup('env', 'KOMODO_DB_NAME') | default('komodo', true) }}"
    komodo_db_username: "{{ lookup('env', 'KOMODO_DB_USERNAME') | default('', true) }}"
    komodo_db_password: "{{ lookup('env', 'KOMODO_DB_PASSWORD') | default('', true) }}"
    komodo_log_level: "{{ lookup('env', 'KOMODO_LOG_LEVEL') | default('info', true) }}"
  tasks:
    - name: "Get node labels"
      ansible.builtin.shell: |
        docker node inspect {{ inventory_hostname }} --format '{{ "{{" }}.Spec.Labels{{ "}}" }}'
      register: node_labels
      changed_when: false
      check_mode: false
      ignore_errors: true

    - name: "Check if this node has role=cloud label"
      ansible.builtin.set_fact:
        has_cloud_role: "{{ 'role:cloud' in node_labels.stdout }}"
      when: node_labels.rc == 0

    - name: "Check if this is the swarm leader"
      ansible.builtin.shell: |
        docker node ls --filter "role=manager" --format "{% raw %}{{.Hostname}} {{.ManagerStatus}}{% endraw %}" | grep "Leader" | awk '{print $1}'
      register: swarm_leader_hostname
      changed_when: false
      check_mode: false

    - name: "Check if this is the cloud node and swarm leader"
      ansible.builtin.set_fact:
        is_cloud_leader: "{{ inventory_hostname == swarm_leader_hostname.stdout and has_cloud_role | default(false) }}"

    - name: "Create Komodo stack directory"
      ansible.builtin.file:
        path: /opt/stacks/komodo
        state: directory
        mode: '0755'
      when: is_cloud_leader

    - name: "Create Komodo docker-compose.yml"
      ansible.builtin.template:
        src: templates/komodo/docker-compose.yml.j2
        dest: /opt/stacks/komodo/docker-compose.yml
        mode: '0644'
      when: is_cloud_leader

    - name: "Deploy Komodo stack"
      ansible.builtin.shell: |
        cd /opt/stacks/komodo && docker stack deploy -c docker-compose.yml komodo
      when: is_cloud_leader
      register: komodo_deploy_result
      changed_when: "'Creating' in komodo_deploy_result.stdout or 'Updating' in komodo_deploy_result.stdout"

    - name: "Wait for Komodo service to be ready"
      ansible.builtin.shell: |
        docker service ps komodo_komodo --format "{{ "{{" }}.CurrentState{{ "}}" }}" | grep "Running"
      register: komodo_service_status
      until: komodo_service_status.stdout is search("Running")
      retries: 20
      delay: 3
      when: is_cloud_leader and not ansible_check_mode

    - name: "Get cloud node Tailscale IP"
      ansible.builtin.set_fact:
        komodo_access_ip: "{{ ansible_facts['tailscale0'].ipv4.address }}"
      when: is_cloud_leader

    - name: "Display Komodo access information"
      ansible.builtin.debug:
        msg: |

          ============================================================
          KOMODO DEPLOYMENT COMPLETE
          ============================================================

          Komodo has been successfully deployed on the cloud node.

          Access Komodo at:
            http://{{ komodo_access_ip | default('UNKNOWN_IP') }}:{{ komodo_port }}

          Service Status: Running
          Stack Name: komodo
          Port: {{ komodo_port }}

          ============================================================
      when: is_cloud_leader
      run_once: true
