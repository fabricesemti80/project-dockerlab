---
- name: "Ordered Reboot of Infrastructure"
  hosts: swarm_managers
  become: true
  serial: 1
  tags: ["reboot"]
  tasks:
    - name: "Display reboot initiation"
      ansible.builtin.debug:
        msg: "Initiating reboot for {{ inventory_hostname }}. This will happen sequentially."

    - name: "Reboot node (Fire and Forget)"
      ansible.builtin.shell: "nohup sh -c 'sleep 2 && shutdown -r now' &"
      async: 1
      poll: 0
      ignore_errors: true
      changed_when: true

    - name: "Wait for node to go down (SSH port closes)"
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: stopped
        timeout: 60
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: "Wait for node to come back (SSH port opens)"
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: "Wait for SSH to be fully usable"
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 60

    - name: "Reset SSH connection to ensure fresh state"
      meta: reset_connection

    - name: "Wait for Docker Socket"
      ansible.builtin.wait_for:
        path: /var/run/docker.sock
        state: present
        timeout: 300
        msg: "Docker socket not found after reboot"

    - name: "Wait for Docker Service to be Active"
      ansible.builtin.command: systemctl is-active docker
      register: docker_state
      retries: 20
      delay: 5
      until: docker_state.stdout == 'active'
      changed_when: false

    - name: "Check Swarm Status"
      ansible.builtin.command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
      register: swarm_status
      failed_when: swarm_status.stdout != 'active'
      changed_when: false
      retries: 10
      delay: 5
      until: swarm_status.stdout == 'active'

    - name: "Verify Node is Ready in Swarm"
      ansible.builtin.command: docker node inspect self --format '{{ "{{" }}.Status.State{{ "}}" }}'
      register: node_state
      failed_when: node_state.stdout != 'ready'
      changed_when: false
      retries: 10
      delay: 5
      until: node_state.stdout == 'ready'

    - name: "Reboot complete"
      ansible.builtin.debug:
        msg: "Node {{ inventory_hostname }} is back online and Swarm is active."
