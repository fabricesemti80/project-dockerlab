---
# Docker installation and configuration playbook
- name: "Install and configure Docker"
  hosts: vms
  become: true
  tags: ["docker", "containers"]

  pre_tasks:
    - name: "Update package lists"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == 'Debian'

    - name: "Get Tailscale interface information"
      ansible.builtin.setup:
        filter: ansible_tailscale0

    - name: "Fail if Tailscale interface not found"
      ansible.builtin.fail:
        msg: "Tailscale interface (tailscale0) not found. Ensure Tailscale is properly configured."
      when: ansible_tailscale0 is not defined

    - name: "Display Tailscale IP being used for Docker"
      ansible.builtin.debug:
        msg: "Docker will bind to Tailscale IP: {{ ansible_tailscale0.ipv4.address }}"

    - name: "Create Docker systemd override directory"
      ansible.builtin.file:
        path: /etc/systemd/system/docker.service.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "Configure Docker systemd override to remove CLI flags"
      ansible.builtin.copy:
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd
        dest: /etc/systemd/system/docker.service.d/override.conf
        owner: root
        group: root
        mode: '0644'
      notify: "Reload systemd"

  handlers:
    - name: "Reload systemd"
      ansible.builtin.systemd:
        daemon_reload: true

  vars:
    # User configuration
    docker_users:
      - "{{ admin_user }}"
      - "{{ ansible_user | default('root') }}"

    # Docker daemon configuration (handled by geerlingguy.docker)
    docker_daemon_options:
      mtu: 1280
      hosts:
        - "tcp://{{ ansible_tailscale0.ipv4.address }}:2376"
        - "unix:///var/run/docker.sock"
      log-driver: "json-file"
      log-opts:
        max-size: "10m"
        max-file: "3"
      storage-driver: "overlay2"
      live-restore: false
      userland-proxy: false
      default-address-pools:
        - base: "10.20.0.0/16"
          size: 24

  roles:
    - geerlingguy.pip
    - geerlingguy.docker

  post_tasks:
    - name: "Refresh package cache after Docker repository added"
      ansible.builtin.apt:
        update_cache: true
      when: ansible_facts['os_family'] == 'Debian'

    - name: "Show Completion Message"
      run_once: true
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "üê≥ DOCKER INSTALLATION COMPLETE"
          - "   ‚Ä¢ Docker Daemon active"
          - "   ‚Ä¢ Users added to docker group"
          - "=================================================="
