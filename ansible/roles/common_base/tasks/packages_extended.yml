---
- name: Install basic system packages
  ansible.builtin.apt:
    update_cache: true
    name: "{{ basic_packages }}"
    state: present

- name: Install neovim dependencies
  ansible.builtin.package:
    name: "{{ neovim_dependencies }}"
    state: present
  when: install_neovim | default(true) | bool

- name: Install python3 and pip
  ansible.builtin.package:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: latest

# --- Fastfetch Installation ---
- name: Check if fastfetch is installed
  ansible.builtin.command: which fastfetch
  register: fastfetch_check
  changed_when: false
  failed_when: false

- name: Install fastfetch from GitHub
  when: fastfetch_check.rc != 0
  block:
    - name: Get latest fastfetch release info
      ansible.builtin.uri:
        url: "https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest"
        return_content: true
      register: fastfetch_release

    - name: Download fastfetch .deb
      ansible.builtin.get_url:
        url: "{{ fastfetch_release.json.assets | selectattr('name', 'search', 'linux-amd64.deb') | map(attribute='browser_download_url') | first }}"
        dest: /tmp/fastfetch.deb
        mode: '0644'

    - name: Install fastfetch .deb
      ansible.builtin.apt:
        deb: /tmp/fastfetch.deb

    - name: Cleanup fastfetch .deb
      ansible.builtin.file:
        path: /tmp/fastfetch.deb
        state: absent

# --- yq Installation ---
- name: Check if yq is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/yq
  register: yq_binary

- name: Download and install yq (YAML processor)
  when: not yq_binary.stat.exists
  block:
    - name: Download yq binary
      ansible.builtin.get_url:
        url: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        dest: /usr/local/bin/yq
        mode: '0755'
        owner: root
        group: root

    - name: Verify yq installation
      ansible.builtin.command: yq --version
      register: yq_version
      changed_when: false

    - name: Display yq version
      ansible.builtin.debug:
        msg: "yq installed: {{ yq_version.stdout }}"

# --- Doppler Installation ---
- name: Install Doppler CLI prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Check if Doppler CLI is already installed
  ansible.builtin.command: which doppler
  register: doppler_check
  changed_when: false
  failed_when: false

- name: Install Doppler CLI using official install script
  when: doppler_check.rc != 0
  ansible.builtin.shell: |
    (curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh || \
     wget -t 3 -qO- https://cli.doppler.com/install.sh) | sh
  args:
    executable: /bin/bash
  changed_when: true

- name: Verify Doppler installation
  ansible.builtin.command: doppler --version
  register: doppler_version
  changed_when: false