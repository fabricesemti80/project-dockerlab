---
# App data directory setup
# Uses default_puid/default_pgid from group_vars, with per-app overrides where needed

- name: Ensure Wallos data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/wallos/{{ item }}"
    state: directory
    owner: "{{ wallos_uid | default(default_puid) }}"
    group: "{{ wallos_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - db
    - logos
  when: install_cephfs | default(false) | bool

- name: Ensure Ghost data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/ghost/{{ item }}"
    state: directory
    owner: "{{ ghost_uid | default(default_puid) }}"
    group: "{{ ghost_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - content
    - mysql
  when: install_cephfs | default(false) | bool

- name: Ensure Backrest data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/backrest/{{ item }}"
    state: directory
    owner: "{{ backrest_uid | default(default_puid) }}"
    group: "{{ backrest_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
    - data
    - cache
  when: install_cephfs | default(false) | bool

- name: Ensure OtterWiki data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/otterwiki/{{ item }}"
    state: directory
    owner: "{{ otterwiki_uid | default(default_puid) }}"
    group: "{{ otterwiki_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - app-data
  when: install_cephfs | default(false) | bool

- name: Ensure Traefik config directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/traefik/config"
    state: directory
    owner: "{{ traefik_uid | default(default_puid) }}"
    group: "{{ traefik_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Traefik acme directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/traefik/acme"
    state: directory
    owner: "{{ traefik_uid | default(default_puid) }}"
    group: "{{ traefik_gid | default(default_pgid) }}"
    mode: '0700'
  when: install_cephfs | default(false) | bool

- name: Create acme.json with correct permissions
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/traefik/acme/acme.json"
    state: touch
    owner: "{{ traefik_uid | default(default_puid) }}"
    group: "{{ traefik_gid | default(default_pgid) }}"
    mode: '0600'
    modification_time: preserve
    access_time: preserve
  when: install_cephfs | default(false) | bool

- name: Template Traefik external services config
  ansible.builtin.template:
    src: external-services.yml.j2
    dest: "{{ cephfs_mount_point }}/docker-shared-data/traefik/config/external-services.yml"
    owner: "{{ traefik_uid | default(default_puid) }}"
    group: "{{ traefik_gid | default(default_pgid) }}"
    mode: '0644'
  when: install_cephfs | default(false) | bool

- name: Ensure Beszel data directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/beszel/data"
    state: directory
    owner: "{{ beszel_uid | default(default_puid) }}"
    group: "{{ beszel_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Filebrowser data directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/filebrowser"
    state: directory
    owner: "{{ filebrowser_uid | default(default_puid) }}"
    group: "{{ filebrowser_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Glance data directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/glance"
    state: directory
    owner: "{{ glance_uid | default(default_puid) }}"
    group: "{{ glance_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Homepage data directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/homepage"
    state: directory
    owner: "{{ homepage_uid | default(default_puid) }}"
    group: "{{ homepage_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Docmost data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/docmost/{{ item }}"
    state: directory
    owner: "{{ docmost_uid | default(default_puid) }}"
    group: "{{ docmost_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - data
    - postgres
    - redis
  when: install_cephfs | default(false) | bool

- name: Ensure Linkwarden data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/linkwarden/{{ item }}"
    state: directory
    owner: "{{ linkwarden_uid | default(default_puid) }}"
    group: "{{ linkwarden_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - data
    - postgres
    - meilisearch
  when: install_cephfs | default(false) | bool

- name: Ensure Jellyfin data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/jellyfin/{{ item }}"
    state: directory
    owner: "{{ jellyfin_uid | default(default_puid) }}"
    group: "{{ jellyfin_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
    - cache
  when: install_cephfs | default(false) | bool

- name: Ensure NZBGet data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/nzbget/{{ item }}"
    state: directory
    owner: "{{ nzbget_uid | default(default_puid) }}"
    group: "{{ nzbget_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
    - downloads
    - downloads/completed
    - downloads/completed/sonarr
    - downloads/completed/radarr
  when: install_cephfs | default(false) | bool

- name: Ensure Prowlarr data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/prowlarr/{{ item }}"
    state: directory
    owner: "{{ prowlarr_uid | default(default_puid) }}"
    group: "{{ prowlarr_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
  when: install_cephfs | default(false) | bool

- name: Ensure Sonarr data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/sonarr/{{ item }}"
    state: directory
    owner: "{{ sonarr_uid | default(default_puid) }}"
    group: "{{ sonarr_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
  when: install_cephfs | default(false) | bool

- name: Ensure Radarr data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/radarr/{{ item }}"
    state: directory
    owner: "{{ radarr_uid | default(default_puid) }}"
    group: "{{ radarr_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
  when: install_cephfs | default(false) | bool

- name: Ensure Jellyseerr data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/jellyseerr/{{ item }}"
    state: directory
    owner: "{{ jellyseerr_uid | default(default_puid) }}"
    group: "{{ jellyseerr_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
  when: install_cephfs | default(false) | bool

- name: Ensure Immich data directories exist
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/immich/{{ item }}"
    state: directory
    owner: "{{ immich_uid | default(default_puid) }}"
    group: "{{ immich_gid | default(default_pgid) }}"
    mode: '0755'
  loop:
    - config
    - postgres
    - model-cache
  when: install_cephfs | default(false) | bool

- name: Ensure Immich Redis directory exists with correct permissions
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/immich/redis"
    state: directory
    owner: "999"
    group: "999"
    mode: '0755'
  when: install_cephfs | default(false) | bool

- name: Ensure Immich Tailscale directory exists
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-shared-data/immich/tailscale"
    state: directory
    owner: "{{ immich_uid | default(default_puid) }}"
    group: "{{ immich_gid | default(default_pgid) }}"
    mode: '0755'
  when: install_cephfs | default(false) | bool
