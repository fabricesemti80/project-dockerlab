---
# Docker Swarm labels role - apply node labels for Dokploy placement constraints
# This role applies labels to swarm nodes for proper service placement

- name: "Verify Docker Swarm is active"
  ansible.builtin.command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
  register: swarm_state
  changed_when: false
  check_mode: no
  tags: [swarm, labels]

- name: "Fail if not in swarm"
  ansible.builtin.fail:
    msg: "Node {{ inventory_hostname }} is not part of a Docker Swarm. Run swarm_bootstrap first."
  when: 
    - not ansible_check_mode
    - swarm_state.stdout != 'active'
  tags: [swarm, labels]

- name: "Get current node labels"
  ansible.builtin.command: docker node inspect {{ inventory_hostname }} --format '{{ "{{" }}.Spec.Labels{{ "}}" }}'
  register: current_labels
  changed_when: false
  when: 
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Debug current labels"
  ansible.builtin.debug:
    msg: "Current labels on {{ inventory_hostname }}: {{ current_labels.stdout | default('N/A in check mode') }}"
  tags: [swarm, labels]

# Apply role labels based on inventory group membership
- name: "Check if role=cloud label exists"
  ansible.builtin.set_fact:
    has_cloud_label: "{{ 'role=cloud' in current_labels.stdout }}"
  when:
    - inventory_hostname in groups.cloud_vms | default([])
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Apply role=cloud label to cloud nodes"
  ansible.builtin.command: docker node update --label-add role=cloud {{ inventory_hostname }}
  when: 
    - inventory_hostname in groups.cloud_vms | default([])
    - not ansible_check_mode or swarm_state.stdout == 'active'
    - not has_cloud_label | default(false)
  tags: [swarm, labels]

- name: "Check if role=home label exists"
  ansible.builtin.set_fact:
    has_home_label: "{{ 'role=home' in current_labels.stdout }}"
  when:
    - inventory_hostname in groups.home_vms | default([])
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Apply role=home label to home nodes"
  ansible.builtin.command: docker node update --label-add role=home {{ inventory_hostname }}
  when: 
    - inventory_hostname in groups.home_vms | default([])
    - not ansible_check_mode or swarm_state.stdout == 'active'
    - not has_home_label | default(false)
  tags: [swarm, labels]

# Apply manager=true label to all manager nodes
- name: "Check if manager=true label exists"
  ansible.builtin.set_fact:
    has_manager_label: "{{ 'manager=true' in current_labels.stdout }}"
  when:
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Apply manager=true label to all managers"
  ansible.builtin.command: docker node update --label-add manager=true {{ inventory_hostname }}
  when: 
    - not ansible_check_mode or swarm_state.stdout == 'active'
    - not has_manager_label | default(false)
  tags: [swarm, labels]

# Apply environment-specific labels
- name: "Check if environment=production label exists"
  ansible.builtin.set_fact:
    has_env_label: "{{ 'environment=production' in current_labels.stdout }}"
  when:
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Apply environment=production label"
  ansible.builtin.command: docker node update --label-add environment=production {{ inventory_hostname }}
  when: 
    - not ansible_check_mode or swarm_state.stdout == 'active'
    - not has_env_label | default(false)
  tags: [swarm, labels]

- name: "Check if network=tailscale label exists"
  ansible.builtin.set_fact:
    has_network_label: "{{ 'network=tailscale' in current_labels.stdout }}"
  when:
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Apply network=tailscale label"
  ansible.builtin.command: docker node update --label-add network=tailscale {{ inventory_hostname }}
  when: 
    - not ansible_check_mode or swarm_state.stdout == 'active'
    - not has_network_label | default(false)
  tags: [swarm, labels]

# Verify labels were applied
- name: "Verify applied labels"
  ansible.builtin.command: docker node inspect {{ inventory_hostname }} --format '{{ "{{" }}.Spec.Labels{{ "}}" }}'
  register: updated_labels
  changed_when: false
  when: 
    - not ansible_check_mode or swarm_state.stdout == 'active'
  tags: [swarm, labels]

- name: "Debug updated labels"
  ansible.builtin.debug:
    msg: "Updated labels on {{ inventory_hostname }}: {{ updated_labels.stdout | default('N/A in check mode') }}"
  tags: [swarm, labels]
