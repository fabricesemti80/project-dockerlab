---
# ------------------------------------------------------------------------------
# Docker Swarm Managers Setup (Full environment)
# ------------------------------------------------------------------------------
- name: Configure Swarm Manager Nodes
  hosts: all
  become: true
  vars:
    # User Management
    primary_user: fs
    ssh_public_key_path: "~/.ssh/fs_home_rsa.pub"
    
    # Feature Toggles
    install_docker: true
    install_zsh: true
    install_ssh_banner: true
    install_storage: true
    install_cephfs: true
    install_swarm: true
    install_portainer: true
    
    # LVM Configuration
    lvm_volume_group_name: "data_vg"
    lvm_data_volume_name: "data_lv"
    lvm_data_volume_size: "80%VG"
    data_mount_point: "/data"
    
    # CephFS Configuration
    cephfs_name: "cephfs-vm"
    cephfs_mount_point: "/mnt/cephfs"
    cephfs_monitors:
      - 10.0.70.10
      - 10.0.70.11
      - 10.0.70.12
    cephfs_user: "admin"
    
    # Portainer Configuration
    portainer_admin_user: admin
    portainer_admin_password: "{{ lookup('env', 'PORTAINER_ADMIN_PASSWORD') }}"
    # Portainer Configuration
    portainer_admin_user: admin
    portainer_admin_password: "{{ lookup('env', 'PORTAINER_ADMIN_PASSWORD') }}"
    apps_domain: "{{ lookup('env', 'DOMAIN') | default('krapulax.net') }}" # Consistent domain # Consistent domain

    # Shell Configuration
    zsh_set_as_default: true
    enable_acl_permissions: false

  roles:
    - role: geerlingguy.docker
      tags: [docker]
    - role: geerlingguy.pip
      tags: [python, pip]
    - role: fresh_install
      tags: [fresh_install]
    - role: docker_swarm
      tags: [swarm]
      when: install_swarm | default(false) | bool

- name: Post-Swarm Setup (Portainer)
  hosts: swarm_managers[0] # Run only on the swarm leader
  become: true
  vars:
    # Inherit variables from the previous play
    install_portainer: true
    portainer_admin_user: admin
    portainer_admin_password: "{{ lookup('env', 'PORTAINER_ADMIN_PASSWORD') }}"
    # Portainer Configuration
    portainer_admin_user: admin
    portainer_admin_password: "{{ lookup('env', 'PORTAINER_ADMIN_PASSWORD') }}"
    apps_domain: "{{ lookup('env', 'DOMAIN') | default('krapulax.net') }}" # Consistent domain
  roles:
    - role: portainer
      tags: [portainer]
      when: install_portainer | default(false) | bool