version: "3.9"

# Backrest - Web UI and orchestrator for Restic backups
# https://github.com/garethgeorge/backrest
#
# Features:
# - Web UI for managing backups, repos, and restores
# - Built-in scheduling (no manual service scaling needed)
# - Browse and restore files from snapshots
# - Discord/Slack/Gotify notifications
# - Supports all restic backends (S3, R2, B2, SFTP, etc.)

services:
  backrest:
    image: garethgeorge/backrest:latest
    hostname: backrest
    environment:
      - TZ=${TZ}
      - BACKREST_PORT=0.0.0.0:9898
      - BACKREST_DATA=/data
      - BACKREST_CONFIG=/config/config.json
      # S3-compatible credentials (Cloudflare R2, AWS S3, Wasabi, MinIO)
      # These are passed to restic for S3 backend access
      - AWS_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
    volumes:
      # Backrest config and data
      - /mnt/cephfs/docker-shared-data/backrest/config:/config
      - /mnt/cephfs/docker-shared-data/backrest/data:/data
      - /mnt/cephfs/docker-shared-data/backrest/cache:/root/.cache/restic
      # Data to back up (read-only)
      - /mnt/cephfs/docker-shared-data:/backups/docker-data:ro
    networks:
      - proxy
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.backrest.rule=Host(`backrest.${DOMAIN}`)"
        - "traefik.http.routers.backrest.entrypoints=websecure"
        - "traefik.http.routers.backrest.tls.certresolver=cloudflare"
        - "traefik.http.services.backrest.loadbalancer.server.port=9898"

        # Homepage Discovery
        - "homepage.group=Infrastructure"
        - "homepage.name=Backrest"
        - "homepage.icon=restic.png"
        - "homepage.href=https://backrest.${DOMAIN}"
        - "homepage.description=Backup Management"

networks:
  proxy:
    external: true
