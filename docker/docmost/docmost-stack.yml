version: "3.9"

services:
  docmost:
    image: docmost/docmost:0.25.3
    networks:
      - proxy
      - docmost-net
    environment:
      - APP_URL=https://doc.${DOMAIN}
      - APP_SECRET=${DOCMOST_APP_SECRET}
      - DATABASE_URL=postgresql://docmost:${DOCMOST_POSTGRES_PASSWORD}@db:5432/docmost?schema=public
      - REDIS_URL=redis://redis:6379
      - TZ=${TZ}
      - HOST=0.0.0.0
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/storage:/app/data/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=proxy"
        - "traefik.http.routers.docmost.rule=Host(`doc.${DOMAIN}`)"
        - "traefik.http.routers.docmost.entrypoints=websecure"
        - "traefik.http.routers.docmost.tls.certresolver=cloudflare"
        - "traefik.http.services.docmost.loadbalancer.server.port=3000"

        # Homepage
        - "homepage.group=Utilities"
        - "homepage.name=Docmost"
        - "homepage.icon=docmost.png"
        - "homepage.href=https://doc.${DOMAIN}"
        - "homepage.description=Knowledge Base"

  db:
    image: postgres:16-alpine
    networks:
      - docmost-net
    environment:
      - POSTGRES_DB=docmost
      - POSTGRES_USER=docmost
      - POSTGRES_PASSWORD=${DOCMOST_POSTGRES_PASSWORD}
      - TZ=${TZ}
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U docmost -d docmost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

  redis:
    image: redis:8.6-alpine
    networks:
      - docmost-net
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          memory: 64M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

  init-permissions:
    image: alpine:latest
    command: >
      sh -c "mkdir -p /mnt/cephfs/docker-shared-data/docmost/storage /mnt/cephfs/docker-shared-data/docmost/postgres /mnt/cephfs/docker-shared-data/docmost/redis &&
      chown -R 1000:1000 /mnt/cephfs/docker-shared-data/docmost/storage &&
      chown -R 70:70 /mnt/cephfs/docker-shared-data/docmost/postgres &&
      chown -R 999:1000 /mnt/cephfs/docker-shared-data/docmost/redis &&
      echo 'Permissions fixed'"
    volumes:
      - /mnt/cephfs/docker-shared-data:/mnt/cephfs/docker-shared-data
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

networks:
  proxy:
    external: true
  docmost-net:
    driver: overlay
