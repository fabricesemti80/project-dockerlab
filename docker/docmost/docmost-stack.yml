version: "3.9"

services:
  docmost:
    image: docmost/docmost:latest
    networks:
      - proxy
      - docmost-net
    environment:
      - APP_URL=https://doc.${DOMAIN}
      - APP_SECRET=${DOCMOST_APP_SECRET}
      - DATABASE_URL=postgresql://docmost:${DOCMOST_POSTGRES_PASSWORD}@db:5432/docmost?schema=public
      - REDIS_URL=redis://redis:6379
      - TZ=${TZ}
      - HOST=0.0.0.0
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/storage:/app/data/storage
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=proxy"
        - "traefik.http.routers.docmost.rule=Host(`doc.${DOMAIN}`)"
        - "traefik.http.routers.docmost.entrypoints=websecure"
        - "traefik.http.routers.docmost.tls.certresolver=cloudflare"
        - "traefik.http.services.docmost.loadbalancer.server.port=3000"

        # Homepage
        - "homepage.group=Utilities"
        - "homepage.name=Docmost"
        - "homepage.icon=docmost.png"
        - "homepage.href=https://doc.${DOMAIN}"
        - "homepage.description=Knowledge Base"

  db:
    image: postgres:16-alpine
    networks:
      - docmost-net
    environment:
      - POSTGRES_DB=docmost
      - POSTGRES_USER=docmost
      - POSTGRES_PASSWORD=${DOCMOST_POSTGRES_PASSWORD}
      - TZ=${TZ}
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/postgres:/var/lib/postgresql/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis:7.2-alpine
    networks:
      - docmost-net
    volumes:
      - /mnt/cephfs/docker-shared-data/docmost/redis:/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  init-permissions:
    image: alpine:latest
    command: >
      sh -c "mkdir -p /mnt/cephfs/docker-shared-data/docmost/storage /mnt/cephfs/docker-shared-data/docmost/postgres /mnt/cephfs/docker-shared-data/docmost/redis &&
      chown -R 1000:1000 /mnt/cephfs/docker-shared-data/docmost/storage &&
      chown -R 70:70 /mnt/cephfs/docker-shared-data/docmost/postgres &&
      chown -R 999:1000 /mnt/cephfs/docker-shared-data/docmost/redis &&
      echo 'Permissions fixed'"
    volumes:
      - /mnt/cephfs/docker-shared-data:/mnt/cephfs/docker-shared-data
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

networks:
  proxy:
    external: true
  docmost-net:
    driver: overlay