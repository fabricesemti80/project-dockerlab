#! ANSIBLE DEPENDENCY: ansible/roles/fresh_install/tasks/app_data_setup.yml
#! - Creates /mnt/cephfs/docker-shared-data/ghost/content directory (owner: 1000:1000)
#! - Creates /mnt/cephfs/docker-shared-data/ghost/mysql directory (owner: 1000:1000)

version: "3.9"

services:
  ghost:
    image: ghost:5-alpine
    environment:
      - TZ=${TZ}
      - NODE_ENV=production
      - url=https://blog.${DOMAIN}
      - database__client=mysql
      - database__connection__host=ghost-db
      - database__connection__user=ghost
      - database__connection__password=${GHOST_DB_PASSWORD}
      - database__connection__database=ghost
      - mail__transport=${GHOST_MAIL_TRANSPORT}
      - mail__options__host=${GHOST_MAIL_HOST}
      - mail__options__port=${GHOST_MAIL_PORT}
      - mail__options__auth__user=${GHOST_MAIL_USER}
      - mail__options__auth__pass=${GHOST_MAIL_PASSWORD}
      - mail__from=${GHOST_MAIL_FROM}
    volumes:
      - /mnt/cephfs/docker-shared-data/ghost/content:/var/lib/ghost/content
    networks:
      - proxy
      - ghost-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2368/ghost/api/admin/site/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
      labels:
        # Traefik
        - "traefik.enable=true"
        - "traefik.http.routers.ghost.rule=Host(`blog.${DOMAIN}`)"
        - "traefik.http.routers.ghost.entrypoints=websecure"
        - "traefik.http.routers.ghost.tls.certresolver=cloudflare"
        - "traefik.http.services.ghost.loadbalancer.server.port=2368"

        # Homepage
        - "homepage.group=Publishing"
        - "homepage.name=Ghost"
        - "homepage.icon=ghost.png"
        - "homepage.href=https://blog.${DOMAIN}"
        - "homepage.description=Blogging Platform"
    depends_on:
      - ghost-db

  ghost-db:
    image: mysql:8.0
    hostname: ghost-db
    environment:
      - TZ=${TZ}
      - MYSQL_ROOT_PASSWORD=${GHOST_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=ghost
      - MYSQL_USER=ghost
      - MYSQL_PASSWORD=${GHOST_DB_PASSWORD}
    volumes:
      - /mnt/cephfs/docker-shared-data/ghost/mysql:/var/lib/mysql
    networks:
      ghost-internal:
        aliases:
          - ghost-db
          - db
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "ghost", "-p${GHOST_DB_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

networks:
  proxy:
    external: true
  ghost-internal:
    driver: overlay
