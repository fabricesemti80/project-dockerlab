version: "3.9"

services:
  socket-proxy:
    image: lscr.io/linuxserver/socket-proxy:latest
    networks:
      - proxy_net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NETWORKS=1
      - NODES=1
      - INFO=1
    deploy:
      mode: global
      placement:
        constraints: [node.role == manager]

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    ports:
      - target: 3000
        published: ${HOMEPAGE_PORT:-3000}
        protocol: tcp
        mode: host
    volumes:
      - ./config:/app/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - HOMEPAGE_ALLOWED_HOSTS=${HOMEPAGE_ALLOWED_HOSTS}
    networks:
      - proxy_net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=proxy_net"

        # Router 1: Internal Domain (Self-Signed / No Auth)
        - "traefik.http.routers.homepage-internal.entrypoints=websecure"
        - "traefik.http.routers.homepage-internal.rule=Host(`${DOMAIN_INTERNAL}`)"
        - "traefik.http.routers.homepage-internal.tls=true"
        - "traefik.http.routers.homepage-internal.service=homepage"

        # Router 2: External Domain (Let's Encrypt)
        - "traefik.http.routers.homepage-external.entrypoints=websecure"
        - "traefik.http.routers.homepage-external.rule=Host(`${DOMAIN}`)"
        - "traefik.http.routers.homepage-external.tls=true"
        - "traefik.http.routers.homepage-external.tls.certresolver=cloudflare"
        - "traefik.http.routers.homepage-external.service=homepage"

        # Service Definition
        - "traefik.http.services.homepage.loadbalancer.server.port=3000"

        # Homepage Labels (Self-Reference)
        - "homepage.group=Infrastructure"
        - "homepage.name=Homepage"
        - "homepage.icon=homepage.png"
        - "homepage.href=http://${DOCKER_SERVER_IP}:${HOMEPAGE_PORT:-3000}"
        - "homepage.description=Application Dashboard"

networks:
  proxy_net:
    external: true
    name: proxy_net