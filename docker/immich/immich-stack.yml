# Immich - Self-hosted Photo and Video Management
# https://immich.app/

services:
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    environment:
      - TZ=${TZ}
      - DB_HOSTNAME=postgres
      - DB_USERNAME=postgres
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=redis
      - IMMICH_MACHINE_LEARNING_URL=http://machine-learning:3003
      - UPLOAD_LOCATION=/usr/src/app/upload
    volumes:
      - /mnt/media/immich:/usr/src/app/upload
      - /mnt/cephfs/docker-shared-data/immich/config:/config
      - /etc/localtime:/etc/localtime:ro
    networks:
      - proxy
      - immich-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:2283/api/server/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "12m"
        max-file: "5"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == worker
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          memory: 1G
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=proxy"
        - "traefik.http.routers.immich.rule=Host(`photos.${DOMAIN}`)"
        - "traefik.http.routers.immich.entrypoints=websecure"
        - "traefik.http.routers.immich.tls.certresolver=cloudflare"
        - "traefik.http.services.immich.loadbalancer.server.port=2283"

        #? Disable buffering for large uploads (photos/videos)
        - "traefik.http.middlewares.immich-buffering.buffering.maxRequestBodyBytes=0"
        - "traefik.http.middlewares.immich-buffering.buffering.memRequestBodyBytes=0"

        #? Headers for mobile app
        - "traefik.http.middlewares.immich-headers.headers.customrequestheaders.X-Forwarded-Proto=https"

        #? Increase timeouts for large file uploads
        - "traefik.http.services.immich.loadbalancer.responseforwarding.flushinterval=100ms"

        #? Apply middlewares
        - "traefik.http.routers.immich.middlewares=immich-buffering,immich-headers"

        # Homepage Discovery
        - "homepage.group=Media"
        - "homepage.name=Immich"
        - "homepage.icon=immich.png"
        - "homepage.href=https://photos.${DOMAIN}"
        - "homepage.description=Photo Management"
    ports:

      #? Local-only access for uploads (use http://<any-swarm-node-ip>:2283 in Immich app's local network setting)
      - target: 2283
        published: 2283
        protocol: tcp
        mode: ingress
    depends_on:
      - postgres
      - redis
      - machine-learning

  machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    environment:
      - TZ=${TZ}
    volumes:
      - /mnt/cephfs/docker-shared-data/immich/model-cache:/cache
    networks:
      immich-internal:
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3003/ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging:
      driver: json-file
      options:
        max-size: "12m"
        max-file: "5"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == worker
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          memory: 1G
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

  redis:
    image: redis:7-alpine
    environment:
      - TZ=${TZ}
    volumes:
      - /mnt/cephfs/docker-shared-data/immich/redis:/data
    networks:
      immich-internal:
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "12m"
        max-file: "5"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == worker
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

  postgres:
    image: tensorchord/pgvecto-rs:pg16-v0.2.1
    environment:
      - TZ=${TZ}
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${IMMICH_DB_PASSWORD}
      - POSTGRES_DB=immich
      - POSTGRES_INITDB_ARGS=--data-checksums
    volumes:
      - /mnt/cephfs/docker-shared-data/immich/postgres:/var/lib/postgresql/data
    networks:
      immich-internal:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d immich"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "12m"
        max-file: "5"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == worker
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

networks:
  proxy:
    external: true
  immich-internal:
    driver: overlay
