version: "3.9"

services:
  mongo:
    image: mongo:4.4.29-focal
    command: --quiet --wiredTigerCacheSizeGB 0.25
    networks:
      - komodo-net
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
    volumes:
      - mongodb_data:/data/db
      - mongo-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  core:
    image: ghcr.io/moghtech/komodo-core:${KOMODO_VERSION:-latest}
    networks:
      - traefik_traefik-public
      - komodo-net
    depends_on:
      - mongo
    environment:
      - KOMODO_DATABASE_ADDRESS=komodo_mongo:27017
      - KOMODO_DATABASE_USERNAME=${MONGO_ROOT_USER}
      - KOMODO_DATABASE_PASSWORD=${MONGO_ROOT_PASSWORD}
      - KOMODO_HOST=https://komodo.${DOMAIN}
      - KOMODO_DOMAIN=komodo.${DOMAIN}
      - KOMODO_TITLE=Komodo
      - KOMODO_LOCAL_AUTH=true
      - KOMODO_ENABLE_NEW_USERS=true
      - KOMODO_DISABLE_USER_REGISTRATION=false
      - KOMODO_INIT_ADMIN_USERNAME=${KOMODO_INIT_ADMIN_USERNAME}
      - KOMODO_INIT_ADMIN_PASSWORD=${KOMODO_INIT_ADMIN_PASSWORD}
      - KOMODO_JWT_SECRET=${KOMODO_JWT_SECRET}
      - KOMODO_WEBHOOK_SECRET=${KOMODO_WEBHOOK_SECRET}
    volumes:
      - /etc/komodo/repos:/repo-cache
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.komodo.rule=Host(`komodo.${DOMAIN}`)"
        - "traefik.http.routers.komodo.entrypoints=websecure"
        - "traefik.http.routers.komodo.tls.certresolver=cloudflare"
        - "traefik.http.services.komodo.loadbalancer.server.port=9120"

  periphery:
    image: ghcr.io/moghtech/komodo-periphery:${KOMODO_VERSION:-latest}
    networks:
      - komodo-net
    environment:
      - PERIPHERY_PASSKEYS=${KOMODO_PASSKEY}
      - PERIPHERY_ROOT_DIRECTORY=/etc/komodo
      - PERIPHERY_SSL_ENABLED=false # Traefik handles SSL
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      - /etc/komodo:/etc/komodo
    ports:
      - target: 8120
        published: 8120
        protocol: tcp
        mode: host
    deploy:
      mode: global

volumes:
  mongodb_data:
  mongo-config:

networks:
  traefik_traefik-public:
    external: true
  komodo-net:
    driver: overlay
    attachable: true
