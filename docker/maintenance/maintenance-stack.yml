#! ANSIBLE DEPENDENCY: ansible/roles/fresh_install/tasks/app_data_setup.yml
#! - Creates /mnt/cephfs/docker-shared-data/diun directory (owner: 0:0)

version: "3.9"

services:
  watchtower:
    image: containrrr/watchtower:1.7.1
    hostname: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ}
      - DOCKER_API_VERSION=1.45
      - WATCHTOWER_SCHEDULE=0 0 8 * * *
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_NOTIFICATIONS=slack
      - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${DISCORD_WATCHTOWER_WEBHOOK}
      - WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER=docker-swarm
      - WATCHTOWER_HTTP_API_METRICS=true
      - WATCHTOWER_HTTP_API_TOKEN=watchtower-metrics-token
      - WATCHTOWER_WARN_ON_HEAD_FAILURE=never
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          memory: 64M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

  # NOTE: This service requires direct Docker socket access for system prune operations.
  # Consider running docker system prune manually or via cron on host instead for better security.
  system-prune:
    image: docker:cli
    command: >
      sh -c "echo '0 6 * * * docker system prune -af --volumes' | crontab - && crond -f"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: global
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
        reservations:
          memory: 32M
    environment:
      - TZ=${TZ}

  # Diun - Docker Image Update Notifier
  # https://github.com/crazy-max/diun
  #
  # Monitors Docker images for updates and sends notifications
  # Does NOT auto-update - just notifies when updates are available
  diun:
    image: crazymax/diun:latest
    hostname: diun
    environment:
      - TZ=${TZ}
      - DIUN_WATCH_SCHEDULE=0 0 6 * * *
      - DIUN_WATCH_FIRSTCHECKNOTIF=false
      - DIUN_PROVIDERS_SWARM=true
      - DIUN_PROVIDERS_SWARM_WATCHBYDEFAULT=true
      - DIUN_NOTIF_DISCORD_WEBHOOKURL=${DISCORD_DIUN_WEBHOOK}
    volumes:
      - /mnt/cephfs/docker-shared-data/diun:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
        reservations:
          memory: 32M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1

networks:
  default:
    driver: overlay
