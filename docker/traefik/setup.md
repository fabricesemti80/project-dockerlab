# Traefik & Whoami Setup Guide (Portainer GitOps)

This guide covers the deployment and configuration of the Traefik Ingress Controller and the `whoami` test service using Portainer's GitOps functionality.

## 1. Prerequisites

- A running Portainer instance.
- A Cloudflare account and a domain.
- A Cloudflare API Token with `Zone:DNS:Edit` and `Zone:Zone:Read` permissions.
- Docker Swarm initialized with appropriate node labels (managed via Ansible).

## 2. Environment Variables

When deploying stacks in Portainer, you must define the following environment variables in the **Environment variables** section of the stack configuration.

Refer to `.envrc_example` in this directory for a template.

| Variable | Description | Example |
| :--- | :--- | :--- |
| `CF_DNS_API_TOKEN` | Cloudflare API Token (Permissions: `Zone:DNS:Edit`, `Zone:Zone:Read`) | `abc123...` |
| `ACME_EMAIL` | Email address for Let's Encrypt registration | `admin@example.com` |
| `DOMAIN` | Your base domain. Used for routing rules (e.g., `traefik.${DOMAIN}`) | `example.com` |

## 3. DNS Setup

1. **Identify the Manager IP**: Find the IP of the manager node where Traefik is constrained to run.
   - *Constraint:* `node.role == manager` AND `node.labels.leader == true`
2. **Create A Records**: In Cloudflare, create A records for the services:
   - `traefik.yourdomain.com` → `[Manager IP]`
   - `whoami.yourdomain.com` → `[Manager IP]`

## 4. Deployment via Portainer

### Deploying Traefik
1. Navigate to **Stacks** > **Add stack**.
2. Select **Repository**.
3. **Name:** `traefik`
4. **Repository URL:** (Your Git Repository URL)
5. **Compose path:** `docker/traefik/traeefik-stack.yml`
6. **Environment variables:** Add `CF_DNS_API_TOKEN`, `ACME_EMAIL`, and `DOMAIN`.
7. Click **Deploy the stack**.

### Deploying Whoami
1. Navigate to **Stacks** > **Add stack**.
2. Select **Repository**.
3. **Name:** `whoami`
4. **Repository URL:** (Your Git Repository URL)
5. **Compose path:** `docker/traefik/whoami-stack.yml`
6. **Environment variables:** Add `DOMAIN`.
7. Click **Deploy the stack**.

## 5. Troubleshooting: "Too Many Redirects"

If you encounter an "Error: Too Many Redirects" when accessing your services via HTTPS:

### The Cause
This occurs when Cloudflare's SSL/TLS mode is set to **Flexible**. Cloudflare connects to Traefik over port 80 (HTTP), but Traefik is configured to redirect all HTTP traffic to HTTPS, creating an infinite loop.

### The Fix
1. Log in to the **Cloudflare Dashboard**.
2. Go to **SSL/TLS > Overview**.
3. Change the encryption mode to **Full (Strict)**. This ensures Cloudflare connects to Traefik via HTTPS using the Let's Encrypt certificates generated by Traefik.

## 6. Verification

### Load Balancing
Visit `https://whoami.yourdomain.com`. Refresh the page multiple times.
- You should see the **Hostname** and **IP** change.
- This confirms that Traefik is successfully load balancing across the 3 replicas of the `whoami` service.
