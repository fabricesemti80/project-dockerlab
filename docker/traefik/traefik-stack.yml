#?  https://doc.traefik.io/traefik/setup/swarm/

#? created outside of this compose file with
#? https://chatgpt.com/share/694a4b8f-9e70-8007-9174-40ee509007ce

#! ANSIBLE DEPENDENCY: ansible/roles/fresh_install/tasks/app_data_setup.yml
#! - Creates /mnt/cephfs/docker-shared-data/traefik/config directory
#! - Templates external-services.yml.j2 for external service routing (e.g., Plex)

# CF_DNS_API_TOKEN=your_cloudflare_api_token
# ACME_EMAIL=your_email@example.com
# DOMAIN=example.com

# NOTE: Docker stack deploy uses v3.x schema; 3.9 is the last version.
#       The 'version' field is deprecated for compose v2, but kept here for Swarm clarity.
version: "3.9"

services:
  traefik:
    image: traefik:v3.6.7
    command:
      # Ping (for healthcheck)
      - "--ping=true"

      # Logging
      - "--log.level=INFO"

      # API / Dashboard
      - "--api=true"
      - "--api.dashboard=true"

      # Swarm provider
      - "--providers.swarm=true"
      - "--providers.swarm.exposedbydefault=false"
      - "--providers.swarm.network=proxy"
      - "--providers.swarm.endpoint=tcp://socket-proxy:2375"

      # File provider (for external services)
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"

      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # Transport timeouts for large uploads (photos, videos)
      - "--serversTransport.responseHeaderTimeout=600s"

      # HTTP â†’ HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Let's Encrypt (Cloudflare DNS-01)
      - "--certificatesresolvers.cloudflare.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    environment:
      - TZ=${TZ}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - /mnt/cephfs/docker-shared-data/traefik/acme:/acme
      - /mnt/cephfs/docker-shared-data/traefik/config:/config:ro

    networks:
      - proxy
      - socket-proxy

    logging:
      driver: json-file
      options:
        max-size: "12m"
        max-file: "5"

    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          memory: 128M
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
      labels:
        - "traefik.enable=true"

        # Add this line to fix "port is missing" error
        - "traefik.http.services.traefik.loadbalancer.server.port=8080"

        # Dashboard router (explicit in v3)
        - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
        - "traefik.http.routers.traefik.entrypoints=websecure"
        - "traefik.http.routers.traefik.tls.certresolver=cloudflare"
        - "traefik.http.routers.traefik.service=api@internal"

        # Homepage Discovery
        - "homepage.group=Infrastructure"
        - "homepage.name=Traefik"
        - "homepage.icon=traefik.png"
        - "homepage.href=https://traefik.${DOMAIN}"
        - "homepage.description=Reverse Proxy"
        # - "homepage.widget.type=traefik"
        # - "homepage.widget.url=https://traefik.${DOMAIN}"

networks:
  proxy:
    external: true
  socket-proxy:
    external: true
