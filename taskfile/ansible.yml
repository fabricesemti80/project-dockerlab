version: '3'

tasks:
  init:
    desc: "Install Ansible Galaxy roles and collections"
    dir: ansible
    cmds:
      - ansible-galaxy install -r requirements.yml
      - ansible-galaxy collection install -r requirements.yml

  template:apply:
    desc: "Apply the Proxmox template creation"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 00-proxmox-template-creation.yml -i inventory/proxmox

  template:plan:
    desc: "Plan the Proxmox template creation"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 00-proxmox-template-creation.yml --check --diff -i inventory/proxmox

  vm:apply:
    desc: "Apply the Proxmox VM deployment"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 01-proxmox-vm-deployment.yml -i inventory/proxmox

  vm:plan:
    desc: "Plan the Proxmox VM deployment"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 01-proxmox-vm-deployment.yml --check --diff -i inventory/proxmox

  hosts:ping:
    desc: "Ping all hosts in the main inventory"
    dir: ansible
    cmds:
      - doppler run -- ansible all -m ping

  hosts:update:
    desc: "Update all hosts and reboot if necessary"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook playbook-update.yaml

  pre:apply:
    desc: "Apply the site preflight checks and updates"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 10-site-preflight.yml

  pre:plan:
    desc: "Plan the site preflight checks and updates"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 10-site-preflight.yml --check --diff

  tail:apply:
    desc: "Apply the tailscale configuration"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 20-site-tailscale.yml

  tail:plan:
    desc: "Plan the tailscale configuration"
    dir: ansible
    cmds:
      - doppler run -- ansible-playbook 20-site-tailscale.yml --check --diff
