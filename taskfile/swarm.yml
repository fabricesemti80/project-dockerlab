version: '3'

vars:
  SSH_CMD: ssh -o StrictHostKeyChecking=no -i ~/.ssh/fs_home_rsa
  MANAGER_IPS: "10.0.30.21 10.0.30.22 10.0.30.23"

tasks:
  status:
    desc: "ðŸ“Š Show full swarm status with leader and service health"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ DOCKER SWARM STATUS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        # Find a responsive manager
        for ip in {{.MANAGER_IPS}}; do
          if {{.SSH_CMD}} fs@$ip "docker node ls" 2>/dev/null; then
            LEADER_IP=$ip
            break
          fi
        done

        if [ -z "$LEADER_IP" ]; then
          echo "âŒ No responsive manager found!"
          exit 1
        fi
    silent: true

  nodes:
    desc: "ðŸ–¥ï¸  Show node status with visual indicators"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ–¥ï¸  NODE STATUS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        for ip in {{.MANAGER_IPS}}; do
          result=$({{.SSH_CMD}} fs@$ip "docker node ls --format '{{`{{.Hostname}}`}}\t{{`{{.Status}}`}}\t{{`{{.Availability}}`}}\t{{`{{.ManagerStatus}}`}}'" 2>/dev/null)
          if [ -n "$result" ]; then
            echo "$result" | while read line; do
              hostname=$(echo "$line" | cut -f1)
              status=$(echo "$line" | cut -f2)
              avail=$(echo "$line" | cut -f3)
              manager=$(echo "$line" | cut -f4)

              if [ "$status" = "Ready" ] && [ "$avail" = "Active" ]; then
                icon="âœ…"
              else
                icon="âŒ"
              fi

              if [ "$manager" = "Leader" ]; then
                role="ðŸ‘‘ Leader"
              elif [ -n "$manager" ]; then
                role="ðŸ”· Manager"
              else
                role="âš™ï¸  Worker"
              fi

              printf "%s %-12s %s\n" "$icon" "$hostname" "$role"
            done
            break
          fi
        done
        echo ""
    silent: true

  services:
    desc: "ðŸ“¦ Show service status with health indicators"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“¦ SERVICE STATUS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        for ip in {{.MANAGER_IPS}}; do
          result=$({{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}}\t{{`{{.Replicas}}`}}'" 2>/dev/null)
          if [ -n "$result" ]; then
            healthy=0
            unhealthy=0

            echo "$result" | while read line; do
              name=$(echo "$line" | cut -f1)
              replicas=$(echo "$line" | cut -f2)
              current=$(echo "$replicas" | cut -d'/' -f1)
              desired=$(echo "$replicas" | cut -d'/' -f2)

              if [ "$current" = "$desired" ] && [ "$current" != "0" ]; then
                icon="âœ…"
              elif [ "$current" = "0" ]; then
                icon="âŒ"
              else
                icon="ðŸ”„"
              fi

              printf "%s %-35s %s\n" "$icon" "$name" "$replicas"
            done
            break
          fi
        done
        echo ""
    silent: true

  unhealthy:
    desc: "ðŸš¨ Show only unhealthy services"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸš¨ UNHEALTHY SERVICES"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        for ip in {{.MANAGER_IPS}}; do
          result=$({{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}}\t{{`{{.Replicas}}`}}'" 2>/dev/null | grep -E '0/[0-9]|[0-9]/0' || true)
          if [ -n "$result" ]; then
            echo "$result" | while read line; do
              name=$(echo "$line" | cut -f1)
              replicas=$(echo "$line" | cut -f2)
              printf "âŒ %-35s %s\n" "$name" "$replicas"
            done
          else
            echo "âœ… All services healthy!"
          fi
          break
        done
        echo ""
    silent: true

  watch:
    desc: "ðŸ‘€ Watch services until all are healthy (poll every 5s)"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ‘€ WATCHING SERVICES (Ctrl+C to stop)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        while true; do
          clear
          echo "ðŸ• $(date '+%H:%M:%S') - Checking service health..."
          echo ""

          for ip in {{.MANAGER_IPS}}; do
            unhealthy=$({{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}} {{`{{.Replicas}}`}}' | grep -E '0/[0-9]' | wc -l" 2>/dev/null)

            # Get node info for each service
            node_info=$({{.SSH_CMD}} fs@$ip "docker service ls -q | xargs -I {} docker service ps {} --filter 'desired-state=running' --format '{{`{{.Name}}`}}\t{{`{{.Node}}`}}' 2>/dev/null" 2>/dev/null)

            if [ "$unhealthy" = "0" ]; then
              echo "âœ… All services are healthy!"
              echo ""
              printf "%-3s %-35s %-8s %s\n" "" "SERVICE" "REPLICAS" "NODE"
              printf "%-3s %-35s %-8s %s\n" "" "â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€"
              {{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}}\t{{`{{.Replicas}}`}}'" 2>/dev/null | while read line; do
                name=$(echo "$line" | cut -f1)
                replicas=$(echo "$line" | cut -f2)
                node=$(echo "$node_info" | grep "^${name}\." | head -1 | cut -f2)
                printf "âœ… %-35s %-8s %s\n" "$name" "$replicas" "$node"
              done
              exit 0
            else
              echo "â³ $unhealthy service(s) still starting..."
              echo ""
              printf "%-3s %-35s %-8s %s\n" "" "SERVICE" "REPLICAS" "NODE"
              printf "%-3s %-35s %-8s %s\n" "" "â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€"
              {{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}}\t{{`{{.Replicas}}`}}'" 2>/dev/null | while read line; do
                name=$(echo "$line" | cut -f1)
                replicas=$(echo "$line" | cut -f2)
                current=$(echo "$replicas" | cut -d'/' -f1)
                desired=$(echo "$replicas" | cut -d'/' -f2)
                node=$(echo "$node_info" | grep "^${name}\." | head -1 | cut -f2)

                if [ "$current" = "$desired" ]; then
                  icon="âœ…"
                elif [ "$current" = "0" ]; then
                  icon="âŒ"
                else
                  icon="ðŸ”„"
                fi
                printf "%s %-35s %-8s %s\n" "$icon" "$name" "$replicas" "$node"
              done
            fi
            break
          done

          sleep 5
        done
    silent: true

  restart:
    desc: "ðŸ”„ Force restart a specific service"
    requires:
      vars: [SERVICE]
    cmds:
      - |
        echo ""
        echo "ðŸ”„ Restarting {{.SERVICE}}..."
        for ip in {{.MANAGER_IPS}}; do
          if {{.SSH_CMD}} fs@$ip "docker service update --force {{.SERVICE}}" 2>/dev/null; then
            echo "âœ… {{.SERVICE}} restarted successfully"
            break
          fi
        done
    silent: true

  restart-all:
    desc: "ðŸ”„ Force restart all unhealthy services"
    cmds:
      - |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ”„ RESTARTING UNHEALTHY SERVICES"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        for ip in {{.MANAGER_IPS}}; do
          services=$({{.SSH_CMD}} fs@$ip "docker service ls --format '{{`{{.Name}}`}} {{`{{.Replicas}}`}}' | grep -E '0/[0-9]' | cut -d' ' -f1" 2>/dev/null)

          if [ -z "$services" ]; then
            echo "âœ… No unhealthy services to restart"
            exit 0
          fi

          for svc in $services; do
            echo "ðŸ”„ Restarting $svc..."
            {{.SSH_CMD}} fs@$ip "docker service update --force $svc" >/dev/null 2>&1
            echo "   âœ… Done"
          done
          break
        done
        echo ""
        echo "â³ Services restarting. Run 'task swarm:watch' to monitor."
    silent: true

  logs:
    desc: "ðŸ“œ Show logs for a service"
    requires:
      vars: [SERVICE]
    cmds:
      - |
        for ip in {{.MANAGER_IPS}}; do
          if {{.SSH_CMD}} fs@$ip "docker service logs {{.SERVICE}} --tail 50" 2>/dev/null; then
            break
          fi
        done
    silent: true
