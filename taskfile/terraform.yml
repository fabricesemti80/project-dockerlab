version: '3'

tasks:

  fmt:
    desc: "Format and validate Hetzner Terraform"
    dir: terraform
    cmds:
      - terraform fmt
      - terraform validate

  init:
    desc: "Initialize Hetzner Terraform"
    dir: terraform
    cmds:
      - if [ -f .envrc ]; then . ./.envrc; fi; terraform init {{.CLI_ARGS}}

  plan:
    desc: "Create a Hetzner Terraform execution plan"
    dir: terraform
    cmds:
      - task: fmt
      - if [ -f .envrc ]; then . ./.envrc; fi; terraform plan -out=tfplan

  apply:
    desc: "Apply the Hetzner Terraform plan"
    dir: terraform
    cmds:
      - task: plan
      - if [ -f .envrc ]; then . ./.envrc; fi; terraform apply tfplan

  destroy:
    desc: "Destroy the Hetzner Terraform-managed infrastructure"
    dir: terraform
    cmds:
      - if [ -f .envrc ]; then . ./.envrc; fi; terraform destroy -auto-approve
