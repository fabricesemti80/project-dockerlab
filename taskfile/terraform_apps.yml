version: '3'

tasks:

  fmt:
    desc: "Format and validate Apps Terraform"
    dir: terraform_apps
    cmds:
      - doppler run -- terraform fmt
      - doppler run -- terraform validate

  init:
    desc: "Initialize Apps Terraform"
    dir: terraform_apps
    cmds:
      - doppler run -- terraform init --upgrade {{.CLI_ARGS}}

  create-network:
    desc: "Create the external traefik-public network"
    cmds:
      - ssh -o StrictHostKeyChecking=no -i ~/.ssh/fs_home_rsa fs@10.0.30.21 "docker network create --driver overlay traefik_traefik-public || true"

  plan:
    desc: "Create an Apps Terraform execution plan"
    dir: terraform_apps
    cmds:
      - task: fmt
      - task: init
      - doppler run -- terraform plan {{.CLI_ARGS}} -out=tfplan

  apply:
    desc: "Apply the Apps Terraform plan"
    dir: terraform_apps
    cmds:
      - task: plan
        vars: { CLI_ARGS: "{{.CLI_ARGS}}" }
      - doppler run -- terraform apply tfplan

  destroy:
    desc: "Destroy the Apps Terraform-managed stacks"
    dir: terraform_apps
    cmds:
      - doppler run -- terraform destroy -auto-approve {{.CLI_ARGS}}
